---
title: "size-term-data-validation"
author: "suzanne"
date: "2023-04-13"
output: html_document
---

# This code helps you find places where the trips go to a destination but the destination doesn't have hhs or jobs
# It automagically maps for you.

# The data is expected to be in a csv with the following columns: 
# Zone number, Trip Demand, Size Variable 1,.... Size Variable N
# One row for each zone, or each zone with trip demand observations
# The output is the ln of the size term coefficients.


# Read in libraries, set working directory, source code for doing the size estimation work
```{r}
library(dplyr)
# for mapping places that have people going to them, but size variables are zero:
library(sf)
library(leaflet)
library(htmlwidgets)
library(stats)

#put your input data here, outputs will also be written out here
setwd("R:/activitysim/estimation/2017_2019_data/size_terms")



```


# Input data as described above, this will output the list of zones that have trips going to them,
# but all the chosen size variables are 0. This can help troubleshoot data issues.
```{r}
validate_inputs <-function(estimdata){
  
  
  nzones <- nrow(estimdata)
  nitems <- ncol(estimdata)
  
  cat("\n")
  cat("\n")
  cat("Num. zones: ", nzones,"\n")
  cat("Num. size variables: ", nitems-2,"\n")
  cat("Num. observations: ", sum(estimdata[,2]), "\n")
  cat("\n")
  
  cat("Validating input data...")
  cat("\n")
  
  obszerosize <- c()
  zerosize <- c()
  for (i in 1:nzones){
    if (sum(estimdata[i,3:nitems]) <= 0){
      #cat("Sum size terms for row ",i," is less than or equal to 0\n")
      zerosize <- c(zerosize,i)
      if( estimdata[i,2] > 0){
        obszerosize <- c(obszerosize,i)
      }
    }
  }
  
  if (length(obszerosize) > 0){
    cat("The following zones have observed choices but zero size and will be ignored:","\n")
    print(estimdata[obszerosize,])
    cat("\n")
    for (i in 1:10000000){}
  }
  return(estimdata[obszerosize,])
}


```


make a map of trips going to places with no stuff
```{r}
map_trips_no_stuff<- function(zone.lyr, pal, map.lat, map.lon, map.zoom, legend.title, legend.subtitle){
  
  trips_nostuff_map <- 
        leaflet::leaflet() %>%
        leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
        leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
        
        leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
        leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                                  options = leaflet::leafletOptions(pane = "maplabels"),
                                  group = "Labels") %>%
        
        leaflet::addEasyButton(leaflet::easyButton(icon="fa-globe",
                                                   title="Region",
                                                   onClick=leaflet::JS("function(btn, map){map.setView([47.615,-122.257],8.5); }"))) %>% # this needs to be not hard-coded)
        leaflet::addPolygons(data=zone.lyr,
                             fillOpacity = 0.7,
                             fillColor = pal(zone.lyr$num_trips),
                             weight = 1.0,
                             color = "#BCBEC0",
                             group="trips",
                             opacity = 0,
                             stroke=FALSE,
                             options = leaflet::leafletOptions(pane = "polygons"),
                             dashArray = "",
                             highlight = leaflet::highlightOptions(
                               weight =5,
                               color = "76787A",
                               dashArray ="",
                               fillOpacity = 0.7,
                               bringToFront = TRUE)) %>%
        
        leaflet::addLegend(pal = pal,
                           values = zone.lyr$num_trips,
                           position = "bottomright",
                           title = paste(legend.title, '<br>', legend.subtitle)) %>%
        
        leaflet::addLayersControl(baseGroups = "CartoDB.VoyagerNoLabels",
                                  overlayGroups = c("Labels", "trips"))%>%
        
        leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom)
    
    return (trips_nostuff_map)
  }


```

This is your input file that includes for each zone, number of trips by purpose and the size variables.
```{r}
trips_purp_lu<-read.csv('R:/activitysim/estimation/2017_2019_data/size_terms/size_terms_2017_2019.csv')
trips_purp_lu<-trips_purp_lu%>%mutate(logaparks=log(1+aparks))
```

point to a shape file of zones to validate where your trips are going relative to the employment and households
```{r}
# Shape file with your zones
#map info
map.lat<-47.615
map.lon<--122.257
map.zoom<-8.5
wa_north <- 2285
wgs_84 <- 4326
maz_file<-'R:/activitysim/conversion/maz_blocks.shp'
maz<-st_read(maz_file)%>%st_set_crs(wa_north)%>%st_transform(wgs_84)


```

write out the list of columns that could be used in the estimation
```{r}
columns_for_selection<-paste(colnames(trips_purp_lu), collapse = ",")
columns_for_selection
```

Starting with eat meal out as an example.


Relevant variables for eating a meal wculd be empfoo_p, empofc_p, empoth_p, empret_p, empsvc_p, hh_p 
perhaps adding log(1+aparks)


```{r}
trips_purp_lu_meal<- trips_purp_lu%>%select(zone, eatout, empfoo_p, empofc_p, empret_p, empsvc_p, hh_p  )
```


```{r}
trips_zone_nothing_df<-validate_inputs(trips_purp_lu_meal)


```
As we were trying to estimate the maximum likelihood we found trips going to places that did not have employment of the types we specified. I wanted to map these few trips to see where they are going.


```{r}

maz_no_stuff<-merge(maz, trips_zone_nothing_df,  by.x='MAZ', by.y= 'zone', all.x=TRUE)%>% replace(is.na(.), 0)%>%rename(num_trips=eatout)

pal <- leaflet::colorNumeric(palette="YlOrRd", domain = maz_no_stuff$num_trips)


```

```{r}
#m<-map_trips_no_stuff(maz_no_stuff, pal, map.lat, map.lon, map.zoom,  legend.title, legend.subtitle)
#saveWidget(m, file='meal_trips_no_size.html')
```


Alternatively estimate a linear model and see what happens
```{r}
fitted_model_meal<-glm(eatout ~ empfoo_p+ empret_p +empsvc_p-1, data=trips_purp_lu)
summary(fitted_model_meal)
```


```{r}
trips_purp_lu_escort<- trips_purp_lu%>%select(zone, escort, empedu_p, empsvc_p, empmed_p, empgov_p,  empofc_p, empfoo_p,  hh_p, stugrd_p, stuhgh_p)

```

```{r}
# trips_zone_nothing_df<-validate_inputs(trips_purp_lu_escort)
# maz_no_stuff<-merge(maz, trips_zone_nothing_df,  by.x='MAZ', by.y= 'zone', all.x=TRUE)%>% replace(is.na(.), 0)%>%rename(num_trips=escort)
# legend.subtitle='Escort Trips'
# m<-map_trips_no_stuff(maz_no_stuff, pal, map.lat, map.lon, map.zoom,  legend.title, legend.subtitle)
# saveWidget(m, file='escort_trips_no_size.html')

```



```{r}
trips_purp_lu_other_discr<- trips_purp_lu%>%select(zone, othdiscr, empsvc_p,empedu_p,empfoo_p,empret_p,hh_p, logaparks)
```

```{r}
trips_zone_nothing_df<-validate_inputs(trips_purp_lu_other_discr) 
maz_no_stuff<-merge(maz, trips_zone_nothing_df,  by.x='MAZ', by.y= 'zone', all.x=TRUE)%>% replace(is.na(.), 0)%>%rename(num_trips=othdiscr)
pal <- leaflet::colorNumeric(palette="YlOrRd", domain = maz_no_stuff$num_trips)
legend.title<-'Survey Trips going to places with no stuff'
legend.subtitle='Other Discr Trips'
m<-map_trips_no_stuff(maz_no_stuff, pal, map.lat, map.lon, map.zoom,  legend.title, legend.subtitle)
saveWidget(m, file='other_trips_no_size.html')

```
